#!/usr/bin/env node
import { writeFileSync } from 'node:fs';
import { resolve } from 'node:path';

const { TEST_RLS_SUPABASE_URL, TEST_RLS_SUPABASE_PUBLISHABLE_KEY } = process.env;

if (!TEST_RLS_SUPABASE_URL || !TEST_RLS_SUPABASE_PUBLISHABLE_KEY) {
  console.error(
    'Missing TEST_RLS_SUPABASE_URL or TEST_RLS_SUPABASE_PUBLISHABLE_KEY environment variables.\n' +
      'Set them (e.g. via .env.local) before running this script.'
  );
  process.exit(1);
}

const payload = [
  '// Auto-generated by scripts/generate-test-rls-env.mjs',
  'window.__TEST_RLS_ENV__ = Object.freeze({',
  `  SUPABASE_URL: ${JSON.stringify(TEST_RLS_SUPABASE_URL)},`,
  `  SUPABASE_PUBLISHABLE_KEY: ${JSON.stringify(TEST_RLS_SUPABASE_PUBLISHABLE_KEY)}`,
  '});',
  '',
].join('\n');

const outputPath = resolve(process.cwd(), 'test-rls-policies.env.js');
writeFileSync(outputPath, payload);

console.log(`Wrote ${outputPath}`);
