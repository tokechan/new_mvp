"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[153],{2890:(e,t,s)=>{s.d(t,{supabase:()=>r,u:()=>n});var a=s(7559);s(5704).env.SUPABASE_SERVICE_ROLE_KEY;let r=(0,a.createBrowserClient)("https://njbormsqqfwnzwbigxuh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qYm9ybXNxcWZ3bnp3YmlneHVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTk0NTUsImV4cCI6MjA3MjQzNTQ1NX0.l7RtcUzoORpe1oUOW4MrahBH9fWjwpGqAc-QeCTYKIQ",{realtime:{params:{eventsPerSecond:10}}});window.supabase=r;let n=()=>r},3084:(e,t,s)=>{s.d(t,{AuthProvider:()=>u,A:()=>d});var a=s(5155),r=s(2115),n=s(2890);class o{async signIn(e,t){let{error:s}=await this.supabase.auth.signInWithPassword({email:e,password:t});return{error:s}}async signUp(e,t,s){let{error:a}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{name:s||""}}});return{error:a}}async signOut(){let{error:e}=await this.supabase.auth.signOut();if(e)throw e}async signInWithGoogle(){try{console.log("Supabase Google OAuth開始..."),console.log("リダイレクトURL:","".concat(window.location.origin,"/auth/callback"));let{error:e}=await this.supabase.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});return e?console.error("Supabase OAuth エラー:",e):console.log("OAuth リダイレクト成功"),{error:e}}catch(e){return console.error("OAuth 予期しないエラー:",e),{error:e}}}async getSession(){let{data:{session:e}}=await this.supabase.auth.getSession();if(!e){console.log("テスト環境: 自動ログインを試行します");try{let{data:e,error:t}=await this.supabase.auth.signInWithPassword({email:"test@example.com",password:"testpassword123"});if(!t)return console.log("テスト用自動ログイン成功"),e.session;console.warn("テスト用自動ログイン失敗:",t.message)}catch(e){console.warn("テスト用自動ログイン例外:",e)}}return e}onAuthStateChange(e){let{data:{subscription:t}}=this.supabase.auth.onAuthStateChange(e);return t}constructor(){this.supabase=(0,n.u)()}}let i=new o;class l{async ensureProfile(e){try{var t,s,a,r;let n=(null==(t=e.user_metadata)?void 0:t.name)||(null!=(r=null==(s=e.email)?void 0:s.split("@")[0])?r:"ユーザー"),{error:o}=await this.supabase.from("profiles").upsert({id:e.id,display_name:n});if(o&&("42P17"===o.code||(null==(a=o.message)?void 0:a.includes("infinite recursion"))))return void console.warn("\uD83D\uDD04 RLSポリシーの無限再帰エラーを検出。プロフィール作成をスキップします。");if(o)throw o}catch(e){console.warn("プロフィールの自動作成/更新に失敗しました:",e)}}async getProfile(e){let{data:t,error:s}=await this.supabase.from("profiles").select("*").eq("id",e).single();if(s)throw s;return t}async updateProfile(e,t){let{data:s,error:a}=await this.supabase.from("profiles").update(t).eq("id",e).select().single();if(a)throw a;return s}async profileExists(e){let{data:t,error:s}=await this.supabase.from("profiles").select("id").eq("id",e).single();return!s&&!!t}constructor(){this.supabase=(0,n.u)()}}new l;let c=(0,r.createContext)(void 0);function u(e){let{children:t}=e,{user:n,session:o,loading:l}=function(){let[e,t]=(0,r.useState)(null),[a,n]=(0,r.useState)(null),[o,i]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{{let e={id:"550e8400-e29b-41d4-a716-446655440000",email:"test@example.com",user_metadata:{name:"テストユーザー"},app_metadata:{},aud:"authenticated",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},a={user:e,access_token:"mock-token",refresh_token:"mock-refresh-token",expires_in:3600,expires_at:Date.now()/1e3+3600,token_type:"bearer"};(async()=>{try{let{supabase:t}=await Promise.resolve().then(s.bind(s,2890));await t.auth.setSession({access_token:a.access_token,refresh_token:a.refresh_token}),await new Promise(e=>setTimeout(e,100));let{data:r}=await t.from("profiles").select("id").eq("id",e.id).single();if(!r){let{error:s}=await t.from("profiles").insert({id:e.id,display_name:"テストユーザー"});s?console.error("プロフィール作成エラー:",s):console.log("テスト用プロフィールを作成しました")}console.log("テスト用セッションをSupabaseクライアントに設定しました")}catch(e){console.warn("テスト用プロフィール作成に失敗:",e)}})(),t(e),n(a),i(!1);return}},[]),{user:e,session:a,loading:o}}(),{signIn:u,signUp:d,signOut:h,signInWithGoogle:g,clearError:p,error:f,loading:m}=function(){let[e,t]=(0,r.useState)(null),[s,a]=(0,r.useState)(!1);return{signIn:async(e,s)=>{try{a(!0),t(null);let r=await i.signIn(e,s);return r.error&&t(r.error.message||"サインインに失敗しました"),r}catch(e){return t(e instanceof Error?e.message:"サインイン中にエラーが発生しました"),{error:e}}finally{a(!1)}},signUp:async(e,s,r)=>{try{a(!0),t(null);let n=await i.signUp(e,s,r);if(n.error)return t(n.error.message||"サインアップに失敗しました"),n;return console.log("サインアップ成功 - プロフィール作成は認証状態変更時に実行されます"),n}catch(e){return t(e instanceof Error?e.message:"サインアップ中にエラーが発生しました"),{error:e}}finally{a(!1)}},signOut:async()=>{try{a(!0),t(null),await i.signOut()}catch(e){throw t(e instanceof Error?e.message:"サインアウト中にエラーが発生しました"),console.error("サインアウトエラー:",e),e}finally{a(!1)}},signInWithGoogle:async()=>{try{a(!0),t(null);let e=await i.signInWithGoogle();if(e.error){let s=(e.error instanceof Error?e.error.message:null)||"Google認証に失敗しました";return t(s),e}return console.log("Google認証成功 - プロフィール作成は認証状態変更時に実行されます"),e}catch(e){return t(e instanceof Error?e.message:"Google認証中に予期しないエラーが発生しました"),{error:e}}finally{a(!1)}},clearError:()=>{t(null)},error:e,loading:s}}();return(0,a.jsx)(c.Provider,{value:{user:n,session:o,loading:l||m,error:f,signIn:u,signUp:d,signOut:h,signInWithGoogle:g,clearError:p},children:t})}function d(){let e=(0,r.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},4153:(e,t,s)=>{s.d(t,{E:()=>c,NotificationProvider:()=>l});var a=s(5155),r=s(2115),n=s(2890),o=s(3084);let i=(0,r.createContext)(void 0);function l(e){let{children:t}=e,[s,l]=(0,r.useState)([]),{user:c}=(0,o.A)(),u=(0,n.u)(),d=(0,r.useCallback)(e=>{let t={...e,id:"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"notification-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),timestamp:new Date,read:!1};l(e=>[t,...e]),"granted"===Notification.permission&&new Notification(e.title,{body:e.message,icon:"/favicon.ico",tag:t.id})},[]),h=(0,r.useCallback)(e=>{l(t=>t.map(t=>t.id===e?{...t,read:!0}:t))},[]),g=(0,r.useCallback)(()=>{l(e=>e.map(e=>({...e,read:!0})))},[]),p=(0,r.useCallback)(e=>{l(t=>t.filter(t=>t.id!==e))},[]),f=(0,r.useCallback)(()=>{l([])},[]),m=s.filter(e=>!e.read).length;return(0,r.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]),(0,r.useEffect)(()=>{if(!c)return;console.log("リアルタイム通知の監視を開始します...");let e=u.channel("chores-changes").on("postgres_changes",{event:"*",schema:"public",table:"chores"},e=>{switch(console.log("家事データの変更を検出:",e),e.eventType){case"INSERT":d({title:"新しい家事が追加されました",message:"".concat(e.new.title,"が追加されました"),type:"info",userId:c.id});break;case"UPDATE":e.new.completed&&!e.old.completed&&d({title:"家事が完了しました",message:"".concat(e.new.title,"が完了されました"),type:"success",userId:c.id});break;case"DELETE":d({title:"家事が削除されました",message:"家事が削除されました",type:"warning",userId:c.id})}}).subscribe(),t=u.channel("thanks-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"thanks"},e=>{console.log("ありがとうメッセージの追加を検出:",e),e.new.to_user===c.id&&d({title:"ありがとうメッセージを受け取りました",message:"".concat(e.new.message),type:"success",userId:c.id})}).subscribe();return()=>{console.log("リアルタイム通知の監視を停止します..."),u.removeChannel(e),u.removeChannel(t)}},[c,u,d]),(0,a.jsx)(i.Provider,{value:{notifications:s,unreadCount:m,addNotification:d,markAsRead:h,markAllAsRead:g,removeNotification:p,clearAllNotifications:f},children:t})}function c(){let e=(0,r.useContext)(i);if(void 0===e)throw Error("useNotifications must be used within a NotificationProvider");return e}}}]);