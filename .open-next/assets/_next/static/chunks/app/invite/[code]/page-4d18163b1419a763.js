(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[820],{63:(e,t,s)=>{"use strict";var r=s(7260);s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})},1579:(e,t,s)=>{Promise.resolve().then(s.bind(s,6705))},2890:(e,t,s)=>{"use strict";s.d(t,{supabase:()=>a,u:()=>n});var r=s(7559);s(5704).env.SUPABASE_SERVICE_ROLE_KEY;let a=(0,r.createBrowserClient)("https://njbormsqqfwnzwbigxuh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qYm9ybXNxcWZ3bnp3YmlneHVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTk0NTUsImV4cCI6MjA3MjQzNTQ1NX0.l7RtcUzoORpe1oUOW4MrahBH9fWjwpGqAc-QeCTYKIQ",{realtime:{params:{eventsPerSecond:10}}});window.supabase=a;let n=()=>a},2946:(e,t,s)=>{"use strict";s.d(t,{QA:()=>p,Op:()=>m,X$:()=>l,u1:()=>u,wl:()=>g,rP:()=>h,JG:()=>d,NQ:()=>x,L4:()=>o,Pu:()=>c});class r{async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s="".concat(this.baseUrl).concat(e),r={"Content-Type":"application/json"};{let e=localStorage.getItem("supabase.auth.token");e&&(r.Authorization="Bearer ".concat(e))}let a={...t,headers:{...r,...t.headers}};try{let e=await fetch(s,a);if(!e.ok){let t=await e.json().catch(()=>({}));throw Error(t.message||t.error||"HTTP ".concat(e.status,": ").concat(e.statusText))}return await e.json()}catch(e){throw console.error("API Request failed:",{url:s,error:e}),e}}async get(e){return this.request(e,{method:"GET"})}async post(e,t){return this.request(e,{method:"POST",body:t?JSON.stringify(t):void 0})}async put(e,t){return this.request(e,{method:"PUT",body:t?JSON.stringify(t):void 0})}async delete(e){return this.request(e,{method:"DELETE"})}constructor(e=""){this.baseUrl=e}}let a=new r;class n{async createInvitation(e){return a.post("/api/invitations",e)}async getInvitations(){return(await a.get("/api/invitations")).invitations}async getInvitation(e){return a.get("/api/invitations/".concat(e))}async acceptInvitation(e){return a.post("/api/invitations/".concat(e))}async cancelInvitation(e){await a.delete("/api/invitations/".concat(e))}async cleanupExpiredInvitations(){await a.post("/api/invitations/cleanup")}}let i=new n;function l(e){let t=encodeURIComponent(e);return"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=".concat(t)}function c(e){return/^[a-f0-9]{32}$/i.test(e)}function o(e){let t=new Date,s=new Date(e).getTime()-t.getTime();if(s<=0)return{days:0,hours:0,minutes:0,expired:!0};let r=Math.floor(s/864e5);return{days:r,hours:Math.floor(s%864e5/36e5),minutes:Math.floor(s%36e5/6e4),expired:!1}}function u(e){return e instanceof Error?e.message:"string"==typeof e?e:"予期しないエラーが発生しました"}function d(e){switch(e){case"pending":return"招待中";case"accepted":return"受諾済み";case"expired":return"期限切れ";case"cancelled":return"キャンセル済み";default:return"不明"}}function h(e){switch(e){case"pending":return"text-yellow-600 bg-yellow-100";case"accepted":return"text-green-600 bg-green-100";case"expired":default:return"text-gray-600 bg-gray-100";case"cancelled":return"text-red-600 bg-red-100"}}async function m(e){return i.createInvitation(e)}async function x(){return i.getInvitations()}async function g(e){return i.getInvitation(e)}async function p(e){return i.acceptInvitation(e)}},3084:(e,t,s)=>{"use strict";s.d(t,{AuthProvider:()=>u,A:()=>d});var r=s(5155),a=s(2115),n=s(2890);class i{async signIn(e,t){let{error:s}=await this.supabase.auth.signInWithPassword({email:e,password:t});return{error:s}}async signUp(e,t,s){let{error:r}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{name:s||""}}});return{error:r}}async signOut(){let{error:e}=await this.supabase.auth.signOut();if(e)throw e}async signInWithGoogle(){try{console.log("Supabase Google OAuth開始..."),console.log("リダイレクトURL:","".concat(window.location.origin,"/auth/callback"));let{error:e}=await this.supabase.auth.signInWithOAuth({provider:"google",options:{redirectTo:"".concat(window.location.origin,"/auth/callback")}});return e?console.error("Supabase OAuth エラー:",e):console.log("OAuth リダイレクト成功"),{error:e}}catch(e){return console.error("OAuth 予期しないエラー:",e),{error:e}}}async getSession(){let{data:{session:e}}=await this.supabase.auth.getSession();if(!e){console.log("テスト環境: 自動ログインを試行します");try{let{data:e,error:t}=await this.supabase.auth.signInWithPassword({email:"test@example.com",password:"testpassword123"});if(!t)return console.log("テスト用自動ログイン成功"),e.session;console.warn("テスト用自動ログイン失敗:",t.message)}catch(e){console.warn("テスト用自動ログイン例外:",e)}}return e}onAuthStateChange(e){let{data:{subscription:t}}=this.supabase.auth.onAuthStateChange(e);return t}constructor(){this.supabase=(0,n.u)()}}let l=new i;class c{async ensureProfile(e){try{var t,s,r,a;let n=(null==(t=e.user_metadata)?void 0:t.name)||(null!=(a=null==(s=e.email)?void 0:s.split("@")[0])?a:"ユーザー"),{error:i}=await this.supabase.from("profiles").upsert({id:e.id,display_name:n});if(i&&("42P17"===i.code||(null==(r=i.message)?void 0:r.includes("infinite recursion"))))return void console.warn("\uD83D\uDD04 RLSポリシーの無限再帰エラーを検出。プロフィール作成をスキップします。");if(i)throw i}catch(e){console.warn("プロフィールの自動作成/更新に失敗しました:",e)}}async getProfile(e){let{data:t,error:s}=await this.supabase.from("profiles").select("*").eq("id",e).single();if(s)throw s;return t}async updateProfile(e,t){let{data:s,error:r}=await this.supabase.from("profiles").update(t).eq("id",e).select().single();if(r)throw r;return s}async profileExists(e){let{data:t,error:s}=await this.supabase.from("profiles").select("id").eq("id",e).single();return!s&&!!t}constructor(){this.supabase=(0,n.u)()}}new c;let o=(0,a.createContext)(void 0);function u(e){let{children:t}=e,{user:n,session:i,loading:c}=function(){let[e,t]=(0,a.useState)(null),[r,n]=(0,a.useState)(null),[i,l]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{{let e={id:"550e8400-e29b-41d4-a716-446655440000",email:"test@example.com",user_metadata:{name:"テストユーザー"},app_metadata:{},aud:"authenticated",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},r={user:e,access_token:"mock-token",refresh_token:"mock-refresh-token",expires_in:3600,expires_at:Date.now()/1e3+3600,token_type:"bearer"};(async()=>{try{let{supabase:t}=await Promise.resolve().then(s.bind(s,2890));await t.auth.setSession({access_token:r.access_token,refresh_token:r.refresh_token}),await new Promise(e=>setTimeout(e,100));let{data:a}=await t.from("profiles").select("id").eq("id",e.id).single();if(!a){let{error:s}=await t.from("profiles").insert({id:e.id,display_name:"テストユーザー"});s?console.error("プロフィール作成エラー:",s):console.log("テスト用プロフィールを作成しました")}console.log("テスト用セッションをSupabaseクライアントに設定しました")}catch(e){console.warn("テスト用プロフィール作成に失敗:",e)}})(),t(e),n(r),l(!1);return}},[]),{user:e,session:r,loading:i}}(),{signIn:u,signUp:d,signOut:h,signInWithGoogle:m,clearError:x,error:g,loading:p}=function(){let[e,t]=(0,a.useState)(null),[s,r]=(0,a.useState)(!1);return{signIn:async(e,s)=>{try{r(!0),t(null);let a=await l.signIn(e,s);return a.error&&t(a.error.message||"サインインに失敗しました"),a}catch(e){return t(e instanceof Error?e.message:"サインイン中にエラーが発生しました"),{error:e}}finally{r(!1)}},signUp:async(e,s,a)=>{try{r(!0),t(null);let n=await l.signUp(e,s,a);if(n.error)return t(n.error.message||"サインアップに失敗しました"),n;return console.log("サインアップ成功 - プロフィール作成は認証状態変更時に実行されます"),n}catch(e){return t(e instanceof Error?e.message:"サインアップ中にエラーが発生しました"),{error:e}}finally{r(!1)}},signOut:async()=>{try{r(!0),t(null),await l.signOut()}catch(e){throw t(e instanceof Error?e.message:"サインアウト中にエラーが発生しました"),console.error("サインアウトエラー:",e),e}finally{r(!1)}},signInWithGoogle:async()=>{try{r(!0),t(null);let e=await l.signInWithGoogle();if(e.error){let s=(e.error instanceof Error?e.error.message:null)||"Google認証に失敗しました";return t(s),e}return console.log("Google認証成功 - プロフィール作成は認証状態変更時に実行されます"),e}catch(e){return t(e instanceof Error?e.message:"Google認証中に予期しないエラーが発生しました"),{error:e}}finally{r(!1)}},clearError:()=>{t(null)},error:e,loading:s}}();return(0,r.jsx)(o.Provider,{value:{user:n,session:i,loading:c||p,error:g,signIn:u,signUp:d,signOut:h,signInWithGoogle:m,clearError:x},children:t})}function d(){let e=(0,a.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},6705:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>c});var r=s(5155),a=s(2115),n=s(63),i=s(3084),l=s(2946);function c(e){let{params:t}=e,[s,c]=(0,a.useState)(""),o=(0,n.useRouter)(),{user:u,signIn:d}=(0,i.A)(),[h,m]=(0,a.useState)(!0),[x,g]=(0,a.useState)(!1),[p,b]=(0,a.useState)(null),[f,w]=(0,a.useState)(null),[y,v]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{c((await t).code)})()},[t]);let j=(0,a.useCallback)(async()=>{try{if(m(!0),b(null),!(0,l.Pu)(s))return void b("無効な招待コードです");let e=await (0,l.wl)(s);e.success&&e.data?w(e.data):b(e.error||"招待情報の取得に失敗しました")}catch(e){b((0,l.u1)(e))}finally{m(!1)}},[s]),N=async()=>{if(!u)return void b("招待を受諾するにはログインが必要です");try{g(!0),b(null);let e=await (0,l.QA)(s);e.success&&e.data?(v(e.data),setTimeout(()=>{o.push("/")},3e3)):b(e.error||"招待の受諾に失敗しました")}catch(e){b((0,l.u1)(e))}finally{g(!1)}};return((0,a.useEffect)(()=>{s&&j()},[s,j]),h)?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-zinc-900",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),(0,r.jsx)("p",{className:"text-gray-600 dark:text-zinc-400",children:"招待情報を確認中..."})]})}):y?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-zinc-900",children:(0,r.jsx)("div",{className:"max-w-md w-full mx-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-8 text-center dark:bg-zinc-800",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"\uD83C\uDF89"}),(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4 dark:text-zinc-100",children:"パートナー連携完了！"}),(0,r.jsxs)("div",{className:"space-y-3 text-gray-600 dark:text-zinc-400",children:[(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"font-medium text-gray-900 dark:text-zinc-100",children:y.partner_name}),"さんとの連携が完了しました"]}),(0,r.jsxs)("p",{children:["共有された家事: ",(0,r.jsxs)("span",{className:"font-bold text-blue-600",children:[y.shared_chores_count,"件"]})]}),(0,r.jsx)("p",{className:"text-sm",children:"これから一緒に家事を管理しましょう！"})]}),(0,r.jsx)("div",{className:"mt-6",children:(0,r.jsx)("button",{onClick:()=>o.push("/"),className:"px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"家事一覧を見る"})}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-4 dark:text-zinc-500",children:"3秒後に自動的にリダイレクトします"})]})})}):p?(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-zinc-900",children:(0,r.jsx)("div",{className:"max-w-md w-full mx-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-8 text-center dark:bg-zinc-800",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"❌"}),(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-4 dark:text-zinc-100",children:"招待エラー"}),(0,r.jsx)("p",{className:"text-red-600 mb-6 dark:text-red-400",children:p}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("button",{onClick:j,className:"w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"再試行"}),(0,r.jsx)("button",{onClick:()=>o.push("/"),className:"w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"ホームに戻る"})]})]})})}):(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-zinc-900",children:(0,r.jsx)("div",{className:"max-w-md w-full mx-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow-lg p-8 dark:bg-zinc-800",children:[(0,r.jsxs)("div",{className:"text-center mb-6",children:[(0,r.jsx)("div",{className:"text-6xl mb-4",children:"\uD83E\uDD1D"}),(0,r.jsx)("h1",{className:"text-2xl font-bold text-gray-900 mb-2 dark:text-zinc-100",children:"パートナー招待"}),(0,r.jsx)("p",{className:"text-gray-600 dark:text-zinc-400",children:"家事管理アプリへの招待が届いています"})]}),f&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 dark:bg-blue-950/30 dark:border-blue-800",children:[(0,r.jsx)("h3",{className:"font-medium text-blue-800 mb-2 dark:text-blue-400",children:"招待者情報"}),(0,r.jsxs)("div",{className:"text-sm text-blue-700 dark:text-blue-300",children:[(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"font-medium",children:"名前:"})," ",f.inviter_name]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"font-medium",children:"メール:"})," ",f.inviter_email]})]})]}),(0,r.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 dark:bg-yellow-950/30 dark:border-yellow-800",children:[(0,r.jsx)("h3",{className:"font-medium text-yellow-800 mb-2 dark:text-yellow-400",children:"有効期限"}),(0,r.jsx)("div",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:(()=>{let e=(0,l.L4)(f.expires_at);return e.expired?(0,r.jsx)("span",{className:"text-red-600 dark:text-red-400",children:"期限切れです"}):e.days>0?"あと ".concat(e.days,"日 ").concat(e.hours,"時間"):e.hours>0?"あと ".concat(e.hours,"時間 ").concat(e.minutes,"分"):"あと ".concat(e.minutes,"分")})()})]}),(0,r.jsxs)("div",{className:"text-center text-sm text-gray-600 dark:text-zinc-400",children:[(0,r.jsx)("p",{children:"\uD83D\uDC6B 一緒に家事を管理しませんか？"}),(0,r.jsx)("p",{children:"招待を受諾すると、家事の追加・完了・削除がリアルタイムで共有されます。"})]}),u?(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("button",{onClick:N,disabled:x,className:"w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:x?"招待を受諾中...":"招待を受諾する"}),(0,r.jsxs)("p",{className:"text-xs text-gray-500 text-center dark:text-zinc-500",children:["現在のアカウント: ",u.email]})]}):(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("button",{onClick:()=>{let e=window.location.href;window.location.href="/auth?redirect=".concat(encodeURIComponent(e))},className:"w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium",children:"ログインして招待を受諾"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 text-center dark:text-zinc-500",children:"招待を受諾するにはログインが必要です"})]})]})]})})})}}},e=>{e.O(0,[559,441,255,358],()=>e(e.s=1579)),_N_E=e.O()}]);