<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLSãƒãƒªã‚·ãƒ¼å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.2s;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .test-step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-step h3 {
            margin-top: 0;
            color: #495057;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pending {
            background: #ffeaa7;
            color: #2d3436;
        }
        .status.running {
            background: #74b9ff;
            color: white;
        }
        .status.success {
            background: #00b894;
            color: white;
        }
        .status.error {
            background: #e17055;
            color: white;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        .test-result {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .test-result.pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ RLSãƒãƒªã‚·ãƒ¼å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ¦‚è¦</h3>
            <p>ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€Supabase Row Level Security (RLS) ãƒãƒªã‚·ãƒ¼ã®å‹•ä½œã‚’æ¤œè¨¼ã—ã¾ã™ã€‚</p>
            <p>èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        </div>
        
        <div class="security-warning">
            <h3>âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦</h3>
            <p>ã“ã®ãƒ†ã‚¹ãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®èªå¯åˆ¶å¾¡ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã‚‚ã®ã§ã™ã€‚</p>
            <p>å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®åˆ¶å¾¡ã«åŠ ãˆã¦ã€RLSã«ã‚ˆã‚‹å¼·åˆ¶çš„ãªåˆ¶å¾¡ãŒé‡è¦ã§ã™ã€‚</p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="button" onclick="startRLSTest()" id="startButton">ğŸš€ RLSãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button class="button warning" onclick="resetTest()" id="resetButton">ğŸ”„ ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="test-step">
            <h3>ã‚¹ãƒ†ãƒƒãƒ— 1: èªè¨¼çŠ¶æ…‹ã®ç¢ºèª <span class="status pending" id="step1Status">å¾…æ©Ÿä¸­</span></h3>
            <p>ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼çŠ¶æ…‹ã¨ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
            <button class="button" onclick="checkAuthStatus()" id="checkAuthButton">ğŸ” èªè¨¼çŠ¶æ…‹ç¢ºèª</button>
            <div id="authResult"></div>
        </div>
        
        <div class="test-step">
            <h3>ã‚¹ãƒ†ãƒƒãƒ— 2: å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ <span class="status pending" id="step2Status">å¾…æ©Ÿä¸­</span></h3>
            <p>èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’èª­ã¿å–ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
            <button class="button" onclick="testReadAccess()" id="testReadButton" disabled>ğŸ“– èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ</button>
            <div id="readResult"></div>
        </div>
        
        <div class="test-step">
            <h3>ã‚¹ãƒ†ãƒƒãƒ— 3: å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ <span class="status pending" id="step3Status">å¾…æ©Ÿä¸­</span></h3>
            <p>èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®¶äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆãƒ»æ›´æ–°ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
            <button class="button" onclick="testWriteAccess()" id="testWriteButton" disabled>âœï¸ æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ</button>
            <div id="writeResult"></div>
        </div>
        
        <div class="test-step">
            <h3>ã‚¹ãƒ†ãƒƒãƒ— 4: ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ <span class="status pending" id="step4Status">å¾…æ©Ÿä¸­</span></h3>
            <p>ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼ˆRLSã«ã‚ˆã‚‹åˆ¶å¾¡ï¼‰ã€‚</p>
            <button class="button danger" onclick="testUnauthorizedAccess()" id="testUnauthorizedButton" disabled>ğŸš« ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <div id="unauthorizedResult"></div>
        </div>
        
        <div class="log" id="testLog">
            <div>ğŸ”’ RLSãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆãƒ­ã‚°</div>
            <div>ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚’å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let currentUser = null;
        let testChoreId = null;
        let supabaseClient = null;
        
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
        function initializeSupabase() {
            const supabaseUrl = 'https://njbormsqqfwnzwbigxuh.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qYm9ybXNxcWZ3bnp3YmlneHVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTk0NTUsImV4cCI6MjA3MjQzNTQ1NX0.l7RtcUzoORpe1oUOW4MrahBH9fWjwpGqAc-QeCTYKIQ';
            
            try {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
                log('âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
                return true;
            } catch (error) {
                log(`âŒ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return false;
            }
        }
        
        function log(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[RLS Test] ${message}`);
        }
        
        function updateStatus(stepId, status, text) {
            const element = document.getElementById(stepId);
            element.className = `status ${status}`;
            element.textContent = text;
        }
        
        function showResult(containerId, success, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="test-result ${success ? 'pass' : 'fail'}">
                    ${success ? 'âœ…' : 'âŒ'} ${message}
                </div>
            `;
        }
        
        async function startRLSTest() {
            log('ğŸš€ RLSãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹');
            document.getElementById('startButton').disabled = true;
            
            // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            if (!initializeSupabase()) {
                log('âŒ Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }
            
            // ã¾ãšèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
            await checkAuthStatus();
        }
        
        async function checkAuthStatus() {
            updateStatus('step1Status', 'running', 'å®Ÿè¡Œä¸­');
            log('ğŸ” èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...');
            
            try {
                // ç›´æ¥Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    throw new Error(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                if (!user) {
                    log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    log('ğŸ’¡ ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã™...');
                    
                    // ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: 'test@example.com',
                        password: 'testpassword123'
                    });
                    
                    if (signInError) {
                        throw new Error(`ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${signInError.message}`);
                    }
                    
                    currentUser = signInData.user;
                    log(`âœ… ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³å®Œäº†: ${currentUser.email}`);
                } else {
                    currentUser = user;
                    log(`âœ… æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§èªè¨¼æ¸ˆã¿: ${user.email}`);
                }
                
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚‚å–å¾—
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError) {
                    log(`âš ï¸ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼: ${profileError.message}`);
                } else if (profile) {
                    log(`ğŸ“‹ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ: ${profile.name || 'N/A'}`);
                }
                
                log(`âœ… èªè¨¼æˆåŠŸ: ${currentUser.email}`);
                log(`ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${currentUser.id}`);
                
                let profileInfo = '';
                if (profile) {
                    profileInfo = `<br>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«: ${profile.name || 'N/A'}`;
                } else if (profileError) {
                    profileInfo = `<br>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼: ${profileError.message}`;
                }
                
                showResult('authResult', true, 
                    `èªè¨¼æ¸ˆã¿: ${currentUser.email}<br>` +
                    `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${currentUser.id}${profileInfo}`
                );
                
                updateStatus('step1Status', 'success', 'å®Œäº†');
                document.getElementById('testReadButton').disabled = false;
                
            } catch (error) {
                log(`âŒ èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('authResult', false, `èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('step1Status', 'error', 'ã‚¨ãƒ©ãƒ¼');
            }
        }
        
        async function testReadAccess() {
            if (!currentUser) {
                log('âŒ èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            updateStatus('step2Status', 'running', 'å®Ÿè¡Œä¸­');
            log('ğŸ“– å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
            
            try {
                // ç›´æ¥Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const { data: chores, error } = await supabaseClient
                    .from('chores')
                    .select('*');
                
                if (error) {
                    throw new Error(`èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const userChores = chores.filter(chore => chore.owner_id === currentUser.id);
                const otherUserChores = chores.filter(chore => chore.owner_id !== currentUser.id);
                
                log(`ğŸ“Š å–å¾—ã—ãŸå®¶äº‹ãƒ‡ãƒ¼ã‚¿: åˆè¨ˆ${chores.length}ä»¶`);
                log(`ğŸ‘¤ è‡ªåˆ†ã®å®¶äº‹: ${userChores.length}ä»¶`);
                log(`ğŸ‘¥ ä»–äººã®å®¶äº‹: ${otherUserChores.length}ä»¶`);
                
                if (otherUserChores.length > 0) {
                    log('âš ï¸ è­¦å‘Š: ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®¶äº‹ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã¾ã—ãŸï¼ˆRLSè¨­å®šè¦ç¢ºèªï¼‰');
                    showResult('readResult', false, 
                        `RLSåˆ¶å¾¡ä¸å‚™: ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿${otherUserChores.length}ä»¶ãŒå–å¾—ã•ã‚Œã¾ã—ãŸ`
                    );
                    updateStatus('step2Status', 'error', 'RLSä¸å‚™');
                } else {
                    log('âœ… RLSèª­ã¿å–ã‚Šåˆ¶å¾¡ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                    showResult('readResult', true, 
                        `æ­£å¸¸: è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿${userChores.length}ä»¶å–å¾—`
                    );
                    updateStatus('step2Status', 'success', 'å®Œäº†');
                    document.getElementById('testWriteButton').disabled = false;
                }
                
            } catch (error) {
                log(`âŒ èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('readResult', false, `èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('step2Status', 'error', 'ã‚¨ãƒ©ãƒ¼');
            }
        }
        
        async function testWriteAccess() {
            if (!currentUser) {
                log('âŒ èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            updateStatus('step3Status', 'running', 'å®Ÿè¡Œä¸­');
            log('âœï¸ å®¶äº‹ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
            
            try {
                const testTitle = `RLSãƒ†ã‚¹ãƒˆ_${Date.now()}`;
                
                // å®¶äº‹ã‚’ä½œæˆ
                log('ğŸ“ æ–°ã—ã„å®¶äº‹ã‚’ä½œæˆã—ã¦ã„ã¾ã™...');
                const { data: newChore, error: createError } = await supabaseClient
                    .from('chores')
                    .insert({
                        title: testTitle,
                        description: 'RLSãƒ†ã‚¹ãƒˆç”¨ã®å®¶äº‹',
                        owner_id: currentUser.id
                    })
                    .select()
                    .single();
                
                if (createError) {
                    throw new Error(`ä½œæˆã‚¨ãƒ©ãƒ¼: ${createError.message}`);
                }
                
                log(`âœ… å®¶äº‹ä½œæˆæˆåŠŸ: ${newChore.title} (ID: ${newChore.id})`);
                testChoreId = newChore.id;
                
                // ä½œæˆã—ãŸå®¶äº‹ã‚’æ›´æ–°
                log('ğŸ“ ä½œæˆã—ãŸå®¶äº‹ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...');
                const { data: updatedChore, error: updateError } = await supabaseClient
                    .from('chores')
                    .update({ description: 'RLSãƒ†ã‚¹ãƒˆç”¨ã®å®¶äº‹ï¼ˆæ›´æ–°æ¸ˆã¿ï¼‰' })
                    .eq('id', newChore.id)
                    .select()
                    .single();
                
                if (updateError) {
                    throw new Error(`æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${updateError.message}`);
                }
                
                log(`âœ… å®¶äº‹æ›´æ–°æˆåŠŸ: ${updatedChore.description}`);
                
                showResult('writeResult', true, 
                    `æ›¸ãè¾¼ã¿æˆåŠŸ: å®¶äº‹ã€Œ${testTitle}ã€ã‚’ä½œæˆãƒ»æ›´æ–°ã—ã¾ã—ãŸ`
                );
                updateStatus('step3Status', 'success', 'å®Œäº†');
                document.getElementById('testUnauthorizedButton').disabled = false;
                
            } catch (error) {
                log(`âŒ æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('writeResult', false, `æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('step3Status', 'error', 'ã‚¨ãƒ©ãƒ¼');
            }
        }
        
        async function testUnauthorizedAccess() {
            if (!currentUser || !testChoreId) {
                log('âŒ å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            updateStatus('step4Status', 'running', 'å®Ÿè¡Œä¸­');
            log('ğŸš« ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');
            
            try {
                // å½ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
                const fakeUserId = '00000000-0000-0000-0000-000000000000';
                const results = {};
                
                // 1. ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥æŒ‡å®šã—ã¦èª­ã¿å–ã‚Šè©¦è¡Œ
                log('ğŸ” ä»–äººã®ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã‚’è©¦è¡Œã—ã¦ã„ã¾ã™...');
                try {
                    const { data: otherChores, error: readError } = await supabaseClient
                        .from('chores')
                        .select('*')
                        .eq('owner_id', fakeUserId);
                    
                    results.unauthorizedRead = {
                        success: !readError,
                        error: readError?.message,
                        dataCount: otherChores?.length || 0
                    };
                    
                    if (readError) {
                        log(`âœ… ä»–äººã®ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚ŠãŒæ­£ã—ãæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ${readError.message}`);
                    } else {
                        log(`âŒ ä»–äººã®ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚ŠãŒè¨±å¯ã•ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸ (${otherChores?.length || 0}ä»¶)`);
                    }
                } catch (error) {
                    results.unauthorizedRead = {
                        success: false,
                        error: error.message
                    };
                    log(`âœ… ä»–äººã®ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šã§ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // 2. ä»–äººã®owner_idã§å®¶äº‹ä½œæˆã‚’è©¦è¡Œ
                log('ğŸ“ ä»–äººã®IDã§å®¶äº‹ä½œæˆã‚’è©¦è¡Œã—ã¦ã„ã¾ã™...');
                try {
                    const { data: newChore, error: createError } = await supabaseClient
                        .from('chores')
                        .insert({
                            title: 'ä¸æ­£ä½œæˆãƒ†ã‚¹ãƒˆ',
                            description: 'ä»–äººã®IDã§ä½œæˆ',
                            owner_id: fakeUserId
                        })
                        .select();
                    
                    results.unauthorizedCreate = {
                        success: !createError,
                        error: createError?.message,
                        created: !!newChore
                    };
                    
                    if (createError) {
                        log(`âœ… ä»–äººã®IDã§ã®å®¶äº‹ä½œæˆãŒæ­£ã—ãæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ${createError.message}`);
                    } else {
                        log(`âŒ ä»–äººã®IDã§ã®å®¶äº‹ä½œæˆãŒè¨±å¯ã•ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸ`);
                    }
                } catch (error) {
                    results.unauthorizedCreate = {
                        success: false,
                        error: error.message
                    };
                    log(`âœ… ä»–äººã®IDã§ã®å®¶äº‹ä½œæˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // 3. å­˜åœ¨ã™ã‚‹è‡ªåˆ†ã®å®¶äº‹ã‚’ä»–äººã®IDã«å¤‰æ›´è©¦è¡Œ
                log('ğŸ”„ å®¶äº‹ã®owner_idå¤‰æ›´ã‚’è©¦è¡Œã—ã¦ã„ã¾ã™...');
                try {
                    const { data: updatedChore, error: updateError } = await supabaseClient
                        .from('chores')
                        .update({ owner_id: fakeUserId })
                        .eq('id', testChoreId)
                        .select();
                    
                    results.unauthorizedUpdate = {
                        success: !updateError,
                        error: updateError?.message,
                        updated: !!updatedChore
                    };
                    
                    if (updateError) {
                        log(`âœ… owner_idå¤‰æ›´ãŒæ­£ã—ãæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ${updateError.message}`);
                    } else {
                        log(`âŒ owner_idå¤‰æ›´ãŒè¨±å¯ã•ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸ`);
                    }
                } catch (error) {
                    results.unauthorizedUpdate = {
                        success: false,
                        error: error.message
                    };
                    log(`âœ… owner_idå¤‰æ›´ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                // çµæœã®è©•ä¾¡
                const isSecure = 
                    !results.unauthorizedRead.success &&
                    !results.unauthorizedCreate.success &&
                    !results.unauthorizedUpdate.success;
                
                if (isSecure) {
                    log('ğŸ‰ RLSãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™ï¼');
                    showResult('unauthorizedResult', true, 
                        'RLSæ­£å¸¸å‹•ä½œ: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãŒã™ã¹ã¦æ‹’å¦ã•ã‚Œã¾ã—ãŸ'
                    );
                    updateStatus('step4Status', 'success', 'å®Œäº†');
                } else {
                    log('âš ï¸ RLSã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                    showResult('unauthorizedResult', false, 
                        'RLSå•é¡Œ: ä¸€éƒ¨ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™'
                    );
                    updateStatus('step4Status', 'error', 'ã‚¨ãƒ©ãƒ¼');
                }
                
            } catch (error) {
                log(`âŒ ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showResult('unauthorizedResult', false, `ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('step4Status', 'error', 'ã‚¨ãƒ©ãƒ¼');
            }
    }
        
        function resetTest() {
            log('ğŸ”„ ãƒ†ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™...');
            
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentUser = null;
            testChoreId = null;
            
            // UI ã‚’ãƒªã‚»ãƒƒãƒˆ
            updateStatus('step1Status', 'pending', 'å¾…æ©Ÿä¸­');
            updateStatus('step2Status', 'pending', 'å¾…æ©Ÿä¸­');
            updateStatus('step3Status', 'pending', 'å¾…æ©Ÿä¸­');
            updateStatus('step4Status', 'pending', 'å¾…æ©Ÿä¸­');
            
            document.getElementById('startButton').disabled = false;
            document.getElementById('checkAuthButton').disabled = false;
            document.getElementById('testReadButton').disabled = true;
            document.getElementById('testWriteButton').disabled = true;
            document.getElementById('testUnauthorizedButton').disabled = true;
            
            // çµæœã‚’ã‚¯ãƒªã‚¢
            document.getElementById('authResult').innerHTML = '';
            document.getElementById('readResult').innerHTML = '';
            document.getElementById('writeResult').innerHTML = '';
            document.getElementById('unauthorizedResult').innerHTML = '';
            
            // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('testLog').innerHTML = `
                <div>ğŸ”’ RLSãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆãƒ­ã‚°</div>
                <div>ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚’å¾…æ©Ÿä¸­...</div>
            `;
            
            log('âœ… ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆå®Œäº†');
        }
    </script>
</body>
</html>